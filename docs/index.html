<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Package to retrieve historical and near realtime data from CDEC • CDECRetrieve</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/united/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="jquery.sticky-kit.min.js"></script><script src="pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">CDECRetrieve</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="/index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    

    
    
<div class="contents">
<div id="cdecretrieve" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#cdecretrieve" class="anchor"></a>CDECRetrieve</h1></div>
<div class="figure">
<img src="https://travis-ci.org/FlowWest/CDECRetrieve.svg?branch=master" alt="travis_mater_status"><p class="caption">travis_mater_status</p>
</div>
</div>
<div id="what-is-cdecretrieve" class="section level1">
<h1 class="hasAnchor">
<a href="#what-is-cdecretrieve" class="anchor"></a>What is CDECRetrieve?</h1>
<p>CDECRetrieve uses the web services provided by the California Data Exchange Center <a href="http://cdec.water.ca.gov/">here</a> as a backend to allow users to download data with a single function call. CDECRetrieve specifically uses the SHEF download service due to the fact that it is the most robust of the services. You can learn more about the SHEF format <a href="http://www.nws.noaa.gov/om/water/resources/SHEF_CodeManual_5July2012.pdf">here</a>. CDECRetrieve came to be after trying to download large amounts of data from CDEC for multiple stations.</p>
</div>
<div id="installation" class="section level1">
<h1 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h1>
<p>Install using <code><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">devtools::install_github</a></code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools::<span class="kw">install_github</span>(<span class="st">"flowwest/CDECRetrieve"</span>, <span class="dt">username=</span><span class="st">""</span>)</code></pre></div>
</div>
<div id="usage" class="section level1">
<h1 class="hasAnchor">
<a href="#usage" class="anchor"></a>Usage</h1>
<div id="basic-usage" class="section level2">
<h2 class="hasAnchor">
<a href="#basic-usage" class="anchor"></a>Basic Usage</h2>
<p>CDECRetrieve exposes several useful functions to query services from CDEC. The main function in the package is <code>retrieve_station_data</code>,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># download data from kwk, sensor 20, duration is event type</span>
kwk_flow &lt;-<span class="st"> </span><span class="kw"><a href="reference/retrieve_station_data.html">retrieve_station_data</a></span>(<span class="st">"KWK"</span>, <span class="st">"20"</span>, <span class="st">"E"</span>, <span class="st">"2000-01-01"</span>, <span class="st">"2002-01-01"</span>)</code></pre></div>
<p>The returned data complies with both tidy data and third normal form, to facilitate both statistical analysia and visualization.</p>
<pre><code># A tibble: 17,544 × 5
   agency_cd            datetime location_id parameter_cd parameter_value
       &lt;chr&gt;              &lt;dttm&gt;       &lt;chr&gt;        &lt;chr&gt;           &lt;chr&gt;
1       CDEC 2000-01-01 00:00:00         KWK          20H            5401
2       CDEC 2000-01-01 01:00:00         KWK          20H            4937
3       CDEC 2000-01-01 02:00:00         KWK          20H            5234
4       CDEC 2000-01-01 03:00:00         KWK          20H            5234
5       CDEC 2000-01-01 04:00:00         KWK          20H            5273
6       CDEC 2000-01-01 05:00:00         KWK          20H            5282
7       CDEC 2000-01-01 06:00:00         KWK          20H            5090
8       CDEC 2000-01-01 07:00:00         KWK          20H            5023
9       CDEC 2000-01-01 08:00:00         KWK          20H            5014
10      CDEC 2000-01-01 09:00:00         KWK          20H            5023
# ... with 17,534 more rows</code></pre>
<p>Note that queries beyond the scope of available data do not break the code! It simply returns the subset of available data.</p>
<p>Tidy means we can do it all!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(ggplot2)

kwk_flow %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(parameter_value &gt;=<span class="st"> </span><span class="dv">0</span>) %&gt;%<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(datetime, parameter_value)) +<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>()</code></pre></div>
<div class="figure">
<img src="images/kwk_flow_ts.png" alt="kwk"><p class="caption">kwk</p>
</div>
</div>
<div id="using-with-purrr" class="section level2">
<h2 class="hasAnchor">
<a href="#using-with-purrr" class="anchor"></a>Using with purrr</h2>
<p>CDECRetrieve does one thing, obtain data from a given station. We strongly believe there are tools in R that can extend its functionality beyond this. Here we use the <code>purrr</code> package to map across a set of desired CDEC stations, and this retrieving multiple station query.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(purrr)
<span class="co"># define the stations of interest</span>
station_list &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"BND"</span>, <span class="st">"KWK"</span>, <span class="st">"FRE"</span>, <span class="st">"CCR"</span>)

<span class="co"># use map to retrieve all possible data</span>
resp &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(station_list, <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/safely">safely</a></span>(function(x) {
  <span class="kw"><a href="reference/retrieve_station_data.html">retrieve_station_data</a></span>(x, <span class="st">"25"</span>, <span class="st">"H"</span>, <span class="st">"2015-01-01"</span>, <span class="st">"2017-02-28"</span>)
}))

<span class="co"># transpose and extract succesfull returns </span>
resp &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/transpose">transpose</a></span>(resp)$results %&gt;%<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>()</code></pre></div>
<p>The query returns</p>
<pre><code>resp

# A tibble: 56,808 × 5
   agency_cd            datetime location_id parameter_cd parameter_value
       &lt;chr&gt;              &lt;dttm&gt;       &lt;chr&gt;        &lt;chr&gt;           &lt;dbl&gt;
1       CDEC 2015-01-01 00:00:00         BND          25H            45.3
2       CDEC 2015-01-01 01:00:00         BND          25H            45.4
3       CDEC 2015-01-01 02:00:00         BND          25H            45.4
4       CDEC 2015-01-01 03:00:00         BND          25H            45.3
5       CDEC 2015-01-01 04:00:00         BND          25H            45.3
6       CDEC 2015-01-01 05:00:00         BND          25H            45.2
7       CDEC 2015-01-01 06:00:00         BND          25H            45.1
8       CDEC 2015-01-01 07:00:00         BND          25H            45.0
9       CDEC 2015-01-01 08:00:00         BND          25H            45.0
10      CDEC 2015-01-01 09:00:00         BND          25H            45.1
# ... with 56,798 more rows</code></pre>
<p>We can see all of the locations that had a result</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(resp$location_id)

  BND   CCR   KWK 
<span class="dv">18936</span> <span class="dv">18936</span> <span class="dv">18936</span> </code></pre></div>
<p>If this is useful enough we can place it in a function for reuse:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">multiple_station_query &lt;-<span class="st"> </span>function(station_list, sensor_num, dur_code, 
                                    start_date, end_date) {
  resp &lt;-<span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map</a></span>(station_list, <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/safely">safely</a></span>(function(x) {
    <span class="kw"><a href="reference/retrieve_station_data.html">retrieve_station_data</a></span>(x, sensor_num, dur_code, start_date, end_date)
  }))
  
  <span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/transpose">transpose</a></span>(resp)$result %&gt;%<span class="st"> </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span>()
}</code></pre></div>
<p>and we call it as follow:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">multiple_station_query</span>(station_list, ....)

<span class="co"># purrr (and functional programming) is great! We can further </span>
<span class="co"># extend the use of the function </span>
<span class="co"># Suppose we want to fix everything but the station, filling the remaining </span>
<span class="co"># values over and over again is annoying so we can partially apply these values </span>
multiple_station_temp_query &lt;-<span class="st"> </span>purrr::<span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/partial">partial</a></span>(
  multiple_station_query, 
  <span class="dt">sensor_num =</span> <span class="st">"20"</span>, 
  <span class="dt">dur_code =</span> <span class="st">"H"</span>,
  <span class="dt">start_date =</span> <span class="st">"2015-01-01"</span>, 
  <span class="dt">end_date =</span> <span class="st">"2017-01-01"</span>
)

<span class="co"># now we can call this function ONLY with stations we are interested in </span>
<span class="kw">multiple_station_temp_query</span>(<span class="st">"KWK"</span>)
<span class="kw">multiple_station_temp_query</span>(<span class="st">"CCR"</span>)
<span class="kw">multiple_station_temp_query</span>(<span class="st">"BND"</span>)</code></pre></div>
<div id="renaming-columns" class="section level3">
<h3 class="hasAnchor">
<a href="#renaming-columns" class="anchor"></a>Renaming Columns</h3>
<p>One of the goals of the package is to return data in a consistent structured way so that functionality can be built on top. If needed one can invoke <code>rename_params</code> on a dataset to add additional columns that specify attributes of the <code>parameter_cd</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">kwk %&gt;%<span class="st"> </span><span class="kw">rename_params</span>()</code></pre></div>
<pre><code>      agency_cd            datetime location_id parameter_cd parameter_value param_name param_units
1          CDEC 2000-01-01 00:00:00         KWK          20H            5401       flow         cfs
2          CDEC 2000-01-01 01:00:00         KWK          20H            4937       flow         cfs
3          CDEC 2000-01-01 02:00:00         KWK          20H            5234       flow         cfs
4          CDEC 2000-01-01 03:00:00         KWK          20H            5234       flow         cfs
5          CDEC 2000-01-01 04:00:00         KWK          20H            5273       flow         cfs
6          CDEC 2000-01-01 05:00:00         KWK          20H            5282       flow         cfs
7          CDEC 2000-01-01 06:00:00         KWK          20H            5090       flow         cfs
8          CDEC 2000-01-01 07:00:00         KWK          20H            5023       flow         cfs
9          CDEC 2000-01-01 08:00:00         KWK          20H            5014       flow         cfs
10         CDEC 2000-01-01 09:00:00         KWK          20H            5023       flow         cfs</code></pre>
<p>All the function does is parse the parameter code and add two additional columns for a human readable name as well as units. <strong>This functionality is still being developed</strong></p>
</div>
</div>
</div>
<div id="alternatives" class="section level1">
<h1 class="hasAnchor">
<a href="#alternatives" class="anchor"></a>Alternatives</h1>
<p>Apart from going straight to CDEC for data, there is another R package called <code>sharpshootR</code> that allows for data retrieval in a similar way that <code>CDECRetrieve</code> does.</p>
</div>
<div id="details" class="section level1">
<h1 class="hasAnchor">
<a href="#details" class="anchor"></a>Details</h1>
<p>The CDEC web services are a mess! Queries do not always respond and the service that fulfills a query is not always the same. The most reliable queries are those from the SHEF download service. The approach taken here is one with an ugly side effect, namely a SHEF file is downloaded temporarily to the working environment, this however is a huge boost in robustness. Having interacted with other services from CDEC none come close the reliability showcased by the SHEF download service. Currently one can pull up to 7 years of data with consistent responses.</p>
<p>In order to go from SHEF –&gt; Tidy, there exist a mapping from SHEF parameter codes to those provided through CDEC. At the moment the list of mappings is one that satisfies the work we do internally, however these are exposed as a simple list in <code>consts.R</code> and can be updated to one’s needs. Ideally and if needed this can be a a static file that gets parsed and brought in to the environment for use.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2 class="hasAnchor">
<a href="#sidebar" class="anchor"></a>License</h2>
<p>file <a href="LICENSE.html">LICENSE</a></p>
<h2>Developers</h2>
<ul class="list-unstyled">
<li>emanuel rodriguez <br><small class="roles"> Author, maintainer </small> </li>
</ul>
</div>

</div>


      <footer><div class="copyright">
  <p>Developed by emanuel rodriguez.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
