<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Retrieve Historical and Near Realtime Data from CDEC • CDECRetrieve</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="jquery.sticky-kit.min.js"></script><script src="pkgdown.js"></script><link href="extra.css" rel="stylesheet">
<meta property="og:title" content="Retrieve Historical and Near Realtime Data from CDEC">
<meta property="og:description" content="CDEC maintains a set of web services at &lt;http://cdec.water.ca.gov/queryTools.html&gt;.
      In order to better interact and analyze the data this R packages allows
      users to quickly and easily retrieve data.">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-home">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">CDECRetrieve</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="articles/CDECRetrieve.html">Get started</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="articles/Introduction_to_CDECRetrieve.html">CDEC Retrieve is now part of CRAN!</a>
    </li>
  </ul>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="contents col-md-9">
    
<div id="cdecretrieve" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#cdecretrieve" class="anchor"></a>CDECRetrieve</h1></div>
<p><img src="https://travis-ci.org/FlowWest/CDECRetrieve.svg?branch=master" alt="travis_mater_status"><a href="https://cran.r-project.org/package=CDECRetrieve"><img src="http://www.r-pkg.org/badges/version/CDECRetrieve" alt="CRAN_Status_Badge"></a></p>
<div id="recent-updates" class="section level2">
<h2 class="hasAnchor">
<a href="#recent-updates" class="anchor"></a>Recent Updates</h2>
<ul>
<li>Map CDEC stations after search for them:</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#requires leaflet!</span>
<span class="kw"><a href="reference/cdec_stations.html">cdec_stations</a></span>(<span class="dt">county=</span><span class="st">"shasta"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="reference/map_stations.html">map_stations</a></span>(<span class="dt">label=</span><span class="op">~</span>station_id)</code></pre></div>
<ul>
<li>New Rating table query available using <code><a href="reference/cdec_rt.html">cdec_rt()</a></code>, view more help with <code><a href="reference/cdec_rt.html">?cdec_rt</a></code>
</li>
<li>new functions names throughout, namely the names of these are more intuitive and all start with <code>cdec_*</code>
</li>
<li>overall refactor of code</li>
</ul>
</div>
</div>
<div id="what-is-cdecretrieve" class="section level1">
<h1 class="hasAnchor">
<a href="#what-is-cdecretrieve" class="anchor"></a>What is CDECRetrieve?</h1>
<p>CDECRetrieve uses the web services provided by the California Data Exchange Center <a href="http://cdec.water.ca.gov/">here</a> as a backend to allow users to download data with a single function call. CDECRetrieve specifically uses the SHEF download service due to the fact that it is the most robust of the services. You can learn more about the SHEF format <a href="http://www.nws.noaa.gov/om/water/resources/SHEF_CodeManual_5July2012.pdf">here</a>.</p>
<p>The design of this package maps different CDEC url endpoints into “services” that make sense. For example there is a <strong>datasets</strong> service that allows the user to view all datasets available at a given location. There is <strong>query/data</strong> service that allows the user to bring observations into memory. The goal is to allow a workflow where a user can pipe reponses from one service into another, and eventually into the <strong>data</strong> service to get the data, and be able to automate this process.</p>
<p>Please see the <em>Details</em> section below for limitations and possible annoyances inherited from the CDEC service.</p>
</div>
<div id="installation" class="section level1">
<h1 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h1>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># stable version </span>
<span class="kw">package.install</span>(<span class="st">"CDECRetrieve"</span>)

<span class="co"># dev version</span>
devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"flowwest/CDECRetrieve"</span>)</code></pre></div>
</div>
<div id="basic-usage" class="section level1">
<h1 class="hasAnchor">
<a href="#basic-usage" class="anchor"></a>Basic Usage</h1>
<p>CDECRetrieve exposes several useful functions to query services from CDEC. The main function in the package is <code>cdec_query</code>,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># download data from kwk, sensor 20, duration is event type</span>
kwk_flow &lt;-<span class="st"> </span><span class="kw"><a href="reference/cdec_query.html">cdec_query</a></span>(<span class="st">"KWK"</span>, <span class="st">"20"</span>, <span class="st">"E"</span>, <span class="st">"2000-01-01"</span>, <span class="st">"2002-01-01"</span>)</code></pre></div>
<p>The data returned,</p>
<pre><code># A tibble: 17,544 × 5
   agency_cd            datetime location_id parameter_cd parameter_value
       &lt;chr&gt;              &lt;dttm&gt;       &lt;chr&gt;        &lt;chr&gt;           &lt;chr&gt;
1       CDEC 2000-01-01 00:00:00         KWK          20H            5401
2       CDEC 2000-01-01 01:00:00         KWK          20H            4937
3       CDEC 2000-01-01 02:00:00         KWK          20H            5234
4       CDEC 2000-01-01 03:00:00         KWK          20H            5234
5       CDEC 2000-01-01 04:00:00         KWK          20H            5273
6       CDEC 2000-01-01 05:00:00         KWK          20H            5282
7       CDEC 2000-01-01 06:00:00         KWK          20H            5090
8       CDEC 2000-01-01 07:00:00         KWK          20H            5023
9       CDEC 2000-01-01 08:00:00         KWK          20H            5014
10      CDEC 2000-01-01 09:00:00         KWK          20H            5023
# ... with 17,534 more rows</code></pre>
<p>Visualize these flows,</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(dplyr)
<span class="kw">library</span>(ggplot2)

kwk_flow <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(parameter_value <span class="op">&gt;=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># sentinel values -9998 and -9997 are present</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(datetime, parameter_value)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_path">geom_line</a></span>()</code></pre></div>
<p><img src="https://raw.githubusercontent.com/FlowWest/CDECRetrieve/master/images/kwk_flow_ts.png" alt="kwk"></p>
<p><em>Note that appart from replacing sentinel values with appropriate NA values, the package does no QA/QC. This can be seen in the plot above, where suspicoius values are apparent.</em></p>
</div>
<div id="details" class="section level1">
<h1 class="hasAnchor">
<a href="#details" class="anchor"></a>Details</h1>
<div id="why-use-shef" class="section level3">
<h3 class="hasAnchor">
<a href="#why-use-shef" class="anchor"></a>Why use shef?</h3>
<p>The package uses the shef download service to download the data. It was chosen for its undocumented ability to download multiple years of data with one call, something the csv service can not do.</p>
</div>
<div id="why-i-download-to-a-temp-dir" class="section level3">
<h3 class="hasAnchor">
<a href="#why-i-download-to-a-temp-dir" class="anchor"></a>Why I download to a temp dir</h3>
<p>If you read the code you will note that it downloads a temp file to the operating system’s temp directory, it then parses the resulting file after reading in with <code>read_csv</code>. The same work can be done with <code><a href="http://www.rdocumentation.org/packages/httr/topics/GET">httr::GET</a></code>, where instead the parsing happens in memory with one of <code>*apply</code> functions or <code><a href="http://www.rdocumentation.org/packages/purrr/topics/map">purrr::map</a></code>. I chose for the first method eventhough its got a really ugly side effect.</p>
<p>Here are some benchmarks for the first and second method:</p>
<p><em>Download Method</em></p>
<table class="table">
<thead><tr class="header">
<th>min</th>
<th>lq</th>
<th>mean</th>
<th>median</th>
<th>uq</th>
<th>max</th>
<th>neval</th>
</tr></thead>
<tbody><tr class="odd">
<td>2.093852</td>
<td>2.460448</td>
<td>2.548882</td>
<td>2.563623</td>
<td>2.691349</td>
<td>2.868398</td>
<td>100</td>
</tr></tbody>
</table>
<p><em>HTTR Method</em></p>
<table class="table">
<thead><tr class="header">
<th>min</th>
<th>lq</th>
<th>mean</th>
<th>median</th>
<th>uq</th>
<th>max</th>
<th>neval</th>
</tr></thead>
<tbody><tr class="odd">
<td>5.786492</td>
<td>5.923293</td>
<td>6.968335</td>
<td>5.949256</td>
<td>6.527922</td>
<td>11.66943</td>
<td>100</td>
</tr></tbody>
</table>
<p>the benchmark expression used were:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># for the download method</span>
CDECRetrieve<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/CDECRetrieve/topics/cdec_query">cdec_query</a></span>(<span class="st">"kwk"</span>, <span class="st">"20"</span>, <span class="st">"h"</span>, <span class="st">"2010-01-01"</span>, <span class="st">"2018-01-01"</span>)

<span class="co"># for the HTTR method</span>
s &lt;-<span class="st"> "http://cdec.water.ca.gov/cgi-progs/querySHEF"</span>

q &lt;-<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">station_id =</span> <span class="st">"kwk"</span>,
  <span class="dt">sensor_num =</span> <span class="st">"20"</span>,
  <span class="dt">dur_code =</span> <span class="st">"h"</span>,
  <span class="dt">start_date =</span> <span class="st">"2010-01-01"</span>,
  <span class="dt">end_date =</span> <span class="st">"2018-01-01"</span>
)

resp &lt;-<span class="st"> </span>httr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/httr/topics/GET">GET</a></span>(s, <span class="dt">query =</span> q)
cont &lt;-<span class="st"> </span>httr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/httr/topics/content">content</a></span>(resp)
in_rows &lt;-<span class="st"> </span><span class="kw">unlist</span>(<span class="kw">strsplit</span>(cont, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>))
data_rows &lt;-<span class="st"> </span>in_rows[<span class="dv">9</span><span class="op">:</span><span class="kw">length</span>(in_rows)]

parse_func &lt;-<span class="st"> </span><span class="cf">function</span>(line) {
  split_at_sapce &lt;-<span class="st"> </span><span class="kw">trimws</span>(<span class="kw">unlist</span>(<span class="kw">strsplit</span>(line, <span class="st">" "</span>)))
  <span class="kw">list</span>(
    <span class="dt">location_id =</span> split_at_space[<span class="dv">2</span>],
    <span class="dt">date =</span> split_at_space[<span class="dv">3</span>],
    <span class="dt">time =</span> split_at_space[<span class="dv">5</span>],
    <span class="dt">shef_code =</span> split_at_space[<span class="dv">6</span>],
    <span class="dt">value =</span> split_at_space[<span class="dv">7</span>]
  )
}

purrr<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/purrr/topics/map">map_df</a></span>(data_rows, parse_func)</code></pre></div>
</div>
</div>

  </div>

  <div class="col-md-3" id="sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cloud.r-project.org/package=CDECRetrieve">https://​cloud.r-project.org/​package=CDECRetrieve</a>
</li>
<li>Report a bug at <br><a href="NA">NA</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li>
<a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a>
</li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Emanuel Rodriguez <br><small class="roles"> Author, maintainer </small>  </li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p>Developed by Emanuel Rodriguez.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
